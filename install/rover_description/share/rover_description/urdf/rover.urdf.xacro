<?xml version="1.0"?>
<robot name="ugv" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- ================= BASE FRAME (AXLE FRAME) ================= -->
  <link name="base_link"/>

  <!-- ================= CHASSIS ================= -->
  <link name="chassis_link">
    <inertial>
      <mass value="450.0"/>
      <origin xyz="0 0 0.2"/>
      <inertia ixx="60" iyy="42" izz="91.5"
               ixy="0" ixz="0" iyz="0"/>
    </inertial>

    <visual>
      <origin xyz="0 0 0.2"/>
      <geometry>
        <box size="1.0 1.2 0.4"/>
      </geometry>
    </visual>

    <collision>
      <origin xyz="0 0 0.2"/>
      <geometry>
        <box size="1.0 1.2 0.4"/>
      </geometry>
    </collision>
  </link>

  <joint name="base_to_chassis" type="fixed">
    <parent link="base_link"/>
    <child link="chassis_link"/>
    <origin xyz="0 0 -0.092"/>
  </joint>

  <!-- ================= WHEEL MACRO ================= -->
  <xacro:macro name="wheel" params="name x y">

    <link name="${name}">
      <visual>
        <origin rpy="1.5707 0 0"/>
        <geometry>
          <cylinder radius="0.292" length="0.12"/>
        </geometry>
      </visual>

      <collision>
        <origin rpy="1.5707 0 0"/>
        <geometry>
          <cylinder radius="0.292" length="0.12"/>
        </geometry>
      </collision>

      <inertial>
        <mass value="15"/>
        <origin xyz="0 0 0"/>
        <inertia ixx="0.34" iyy="0.34" izz="0.64"
                 ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <joint name="${name}_joint" type="continuous">
      <parent link="base_link"/>
      <child link="${name}"/>
      <origin xyz="${x} ${y} 0"/>
      <axis xyz="0 1 0"/>
    </joint>

    <gazebo reference="${name}">
      <mu1>3.0</mu1>
      <mu2>3.0</mu2>
      <kp>100000</kp>
      <kd>10</kd>
    </gazebo>

  </xacro:macro>

  <!-- ================= WHEELS ================= -->
  <xacro:wheel name="front_left_wheel"  x="0.4"  y="0.675"/>
  <xacro:wheel name="front_right_wheel" x="0.4"  y="-0.675"/>
  <xacro:wheel name="rear_left_wheel"   x="-0.4" y="0.675"/>
  <xacro:wheel name="rear_right_wheel"  x="-0.4" y="-0.675"/>

  <!-- ================= SENSORS ================= -->
  <link name="lidar_link"/>
  <joint name="lidar_joint" type="fixed">
    <parent link="chassis_link"/>
    <child link="lidar_link"/>
    <origin xyz="0.2 0 0.4"/>
  </joint>

  <link name="imu_link"/>
  <joint name="imu_joint" type="fixed">
    <parent link="chassis_link"/>
    <child link="imu_link"/>
    <origin xyz="0 0 0.15"/>
  </joint>

  <link name="camera_link"/>
  <joint name="camera_joint" type="fixed">
    <parent link="chassis_link"/>
    <child link="camera_link"/>
    <origin xyz="0.25 0 0.35"/>
  </joint>

  <link name="gps_link"/>
  <joint name="gps_joint" type="fixed">
    <parent link="chassis_link"/>
    <child link="gps_link"/>
    <origin xyz="-0.2 0 0.45"/>
  </joint>

  <!-- ================= ROS2 CONTROL ================= -->
  <ros2_control name="ugv_system" type="system">
    <hardware>
      <plugin>gazebo_ros2_control/GazeboSystem</plugin>
    </hardware>

    <joint name="front_left_wheel_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="front_right_wheel_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="rear_left_wheel_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="rear_right_wheel_joint">
      <command_interface name="velocity"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
  </ros2_control>

  <gazebo>
    <plugin filename="libgazebo_ros2_control.so" name="gazebo_ros2_control">
      <parameters>$(find rover_simulation)/config/controllers.yaml</parameters>
    </plugin>
  </gazebo>

</robot>
